<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/static/redoc/favicon.png" />
    <link rel="stylesheet" href="/static/home/bulma.min.css" />
    <style>
      .column-title {
        font-size: 26px;
        font-weight: bold;
      }

      .img-zoom-1 {
        max-width: 200px;
        max-height: 200px;
      }
    </style>
    <title>Chat</title>
  </head>
  <body>
    <div class="container is-fluid" id="app">
      <section class="hero is-warning">
        <div class="hero-body">
          <h1 class="title">对话补全 Chat</h1>
          <h2 class="subtitle">对话补全接口，提供模型问答能力</h2>
        </div>
      </section>
      <div class="columns is-desktop" style="margin-top: 20px">
        <div class="column">
          <h2 class="column-title">请求参数：</h2>
          <div class="field">
            <label class="label">模型地址：</label>
            <div class="control">
              <input
                v-model="address"
                class="input is-warning"
                type="text"
                placeholder="http://localhost:8000/v1/chat/completions"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="notification is-warning" v-show="showAddressTip">
            请求地址不能为空
          </div>

          <div class="field">
            <label class="label">模型秘钥：</label>
            <div class="control">
              <input
                v-model="key"
                class="input is-warning"
                type="text"
                placeholder="sk-123456"
              />
            </div>
          </div>

          <div class="field">
            <label class="label">模型名称：</label>
            <div class="control">
              <input
                v-model="modelName"
                class="input is-warning"
                type="text"
                placeholder="qwen-max"
              />
            </div>
            <p class="help is-warning">
              常见对话模型：qwen3,qwen3-vl,deepseek-r1,GPT-5,GPT-4o
            </p>
          </div>
          <div class="notification is-warning" v-show="showModelNameTip">
            模型名称不能为空
          </div>

          <div class="field">
            <label class="label">stream 流式输出：</label>
            <div class="control">
              <label class="radio" style="margin-right: 20px">
                <input type="radio" v-model="isStream" value="yes" />
                是
              </label>
              <label class="radio">
                <input type="radio" v-model="isStream" value="no" />
                否
              </label>
            </div>
          </div>

          <div class="field">
            <label class="label">图片理解：</label>
            <div class="control">
              <label class="radio" style="margin-right: 20px">
                <input type="radio" v-model="describeImg" value="yes" />
                是
              </label>
              <label class="radio">
                <input type="radio" v-model="describeImg" value="no" />
                否
              </label>
            </div>
          </div>

          <div class="field test-img" v-show="describeImg === 'yes'">
            <label class="label">测试图片：</label>
            <div class="control is-flex is-align-items-center">
              <!-- 原图展示 -->
              <figure
                @click="toggleZoom1"
                class="image"
                style="border: 1px solid #000; margin-right: 10px"
              >
                <img
                  :src="testImage"
                  :class="{ 'img-zoom-1': isImgZoom1 }"
                  alt="Test image"
                />
              </figure>

              <!-- 上传按钮 -->
              <div class="file is-normal is-boxed">
                <label class="file-label">
                  <input
                    class="file-input"
                    type="file"
                    accept="image/*"
                    @change="handleImageUpload"
                  />
                  <span class="file-cta">
                    <span class="file-label"> 选择测试图片 </span>
                  </span>
                </label>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label">提问问题：</label>
            <div class="control">
              <textarea
                v-model="question"
                class="textarea is-warning"
                rows="4"
                placeholder="提问问题"
                spellcheck="false"
                autocomplete="off"
              ></textarea>
            </div>
          </div>
          <div class="notification is-warning" v-show="showQuestionTip">
            提问问题不能为空
          </div>

          <div class="control is-expanded">
            <button
              @click="sendRequest"
              class="button is-warning is-fullwidth"
              :disabled="loading"
              :class="{ 'is-loading': loading }"
            >
              发起请求
            </button>
          </div>
        </div>
        <div class="column">
          <h2 class="column-title">返回结果：</h2>
          <div class="field">
            <label class="label">JSON or SSE：</label>
            <textarea
              ref="resultJsonTextarea"
              v-model="resultJson"
              class="textarea is-warning"
              rows="10"
              placeholder="输出结果"
              spellcheck="false"
              autocomplete="off"
            ></textarea>
          </div>
          <div class="field">
            <label class="label"
              >TEXT：<span v-show="isStream === 'yes'"
                >(速度：{{textIn1sLength}}/s)</span
              ></label
            >
            <textarea
              ref="resultTextTextarea"
              v-model="resultText"
              class="textarea is-warning"
              rows="10"
              placeholder="输出结果"
              spellcheck="false"
              autocomplete="off"
            ></textarea>
          </div>
        </div>
      </div>
    </div>
    <script src="/static/home/vue3.global.prod.js"></script>
    <script>
      const { createApp, ref, onMounted, watch } = Vue;

      createApp({
        setup() {
          // 响应式数据
          const address = ref("");
          const key = ref("");
          const modelName = ref("");
          const isStream = ref("yes"); // 默认是流式输出
          const describeImg = ref("no"); // 默认不描述图片
          const question = ref("");
          const resultJson = ref("");
          const resultText = ref("");
          const resultJsonTextarea = ref(null);
          const resultTextTextarea = ref(null);
          const showAddressTip = ref(false);
          const showModelNameTip = ref(false);
          const showQuestionTip = ref(false);
          const loading = ref(false);
          const testImage = ref(
            "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAgACMDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3misjxPrv/CN+HrzVBZT3jW8TyLDCMbtqFzuboigKSSfoAWKqbeoz30Fuv9nWSXdw77Qss/kxoMElnbDEDjHyqxyRwBlgAXKKwNN17UL/AE/Ud2jeVqthdG0ktBdK0bMQjK4lwP3ZSRGJ27gNw2kgAyaLrV9e6pqGl6ppiWV5ZpFKDDc+fFNFJuCsrFVYENHIpBUdARkGgDbooooAxPGUE114G8QW9vE808um3KRxxqWZ2MTAAAckk9qp+OtW1fSdDg/sW1nkubu6jtXuIbV7k2UbZ3T+UoJfaBwOmSOvQ9PRQBzljLYJ4bvJbe31idHc/a5HtpoLuZiFDy4ZUckKRjyxwFCxj5VUV/CcE0Oqaq9tFqKaLMkD2zaipErzfOsp/efvyMLEAZueML8gWurooAKKKKAP/9k="
          );
          const isImgZoom1 = ref(true);

          let textIn1s = "";
          let textIn1sInterval = null;
          const textIn1sLength = ref(0);
          let textIn1sSeconds = 0;

          // 监听图片理解选项变化，自动更新问题
          watch(
            () => describeImg.value,
            (newValue) => {
              if (newValue === "yes") {
                question.value = "描述一下图片";
              } else {
                let newQuestion = "苹果公司的产品有哪些？";
                if (
                  localStorage.getItem(storageKeys.question) != "描述一下图片"
                ) {
                  newQuestion = localStorage.getItem(storageKeys.question);
                }
                question.value = newQuestion;
              }
            }
          );

          // 本地存储键名映射
          const storageKeys = {
            address: "chat_address",
            key: "chat_key",
            modelName: "chat_modelName",
            isStream: "chat_is_stream",
            describeImg: "chat_describe_img",
            question: "chat_question",
            resultJson: "chat_result_json",
            resultText: "chat_result_text",
          };

          // 从本地存储加载数据
          const loadFromStorage = () => {
            address.value =
              localStorage.getItem(storageKeys.address) ||
              `${location.origin}/v1/chat/completions`;
            key.value = localStorage.getItem(storageKeys.key) || "";
            modelName.value =
              localStorage.getItem(storageKeys.modelName) || "qwen3";
            isStream.value =
              localStorage.getItem(storageKeys.isStream) || "yes";
            describeImg.value =
              localStorage.getItem(storageKeys.describeImg) || "no";
            question.value =
              localStorage.getItem(storageKeys.question) ||
              "苹果公司的产品有哪些？";
            resultJson.value =
              localStorage.getItem(storageKeys.resultJson) || "";
            resultText.value =
              localStorage.getItem(storageKeys.resultText) || "";
          };

          // 只在请求成功后保存数据到本地存储
          const saveToStorage = () => {
            localStorage.setItem(storageKeys.address, address.value);
            localStorage.setItem(storageKeys.key, key.value);
            localStorage.setItem(storageKeys.modelName, modelName.value);
            localStorage.setItem(storageKeys.isStream, isStream.value);
            localStorage.setItem(storageKeys.describeImg, describeImg.value);
            localStorage.setItem(storageKeys.question, question.value);
            localStorage.setItem(storageKeys.resultJson, resultJson.value);
            localStorage.setItem(storageKeys.resultText, resultText.value);
          };

          // 处理图片上传并转为 base64
          const handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              testImage.value = e.target.result;
            };
            reader.readAsDataURL(file);
            // 清空 input，确保同一张图能再次触发 change
            event.target.value = "";
          };

          const toggleZoom1 = () => {
            isImgZoom1.value = !isImgZoom1.value;
          };

          const scrollTextareaToBottom = (refTextarea) => {
            let scheduled = false; // ← 改名更准确

            const innerScrollTextareaToBottom = () => {
              if (scheduled) {
                return;
              }
              scheduled = true;

              requestAnimationFrame(() => {
                if (refTextarea.value) {
                  refTextarea.value.scrollTop = refTextarea.value.scrollHeight;
                }
                scheduled = false;
              });
            };

            return innerScrollTextareaToBottom;
          };

          const scrollResultJsonToBottom =
            scrollTextareaToBottom(resultJsonTextarea);
          const scrollResultTextToBottom =
            scrollTextareaToBottom(resultTextTextarea);

          // 发送请求
          const sendRequest = async () => {
            // 重置提示信息
            showAddressTip.value = false;
            showModelNameTip.value = false;
            showQuestionTip.value = false;

            // 验证输入
            if (!address.value.trim()) {
              showAddressTip.value = true;
              return;
            }

            if (!modelName.value.trim()) {
              showModelNameTip.value = true;
              return;
            }

            if (!question.value.trim()) {
              showQuestionTip.value = true;
              return;
            }

            loading.value = true;

            try {
              let content = null;
              if (describeImg.value === "yes") {
                content = [];
                content.push({
                  type: "image_url",
                  image_url: {
                    url: testImage.value,
                  },
                });
                content.push({ type: "text", text: question.value });
              } else {
                content = question.value;
              }

              const response = await fetch(address.value, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${key.value}`,
                },
                body: JSON.stringify({
                  stream: isStream.value === "yes",
                  model: modelName.value,
                  top_p: 1,
                  messages: [
                    {
                      role: "user",
                      content: content,
                    },
                  ],
                }),
              });

              if (isStream.value === "yes") {
                resultJson.value = "";
                resultText.value = "";

                if (!response.body) {
                  resultJson.value =
                    "ReadableStream not supported in this browser";
                  return;
                }

                textIn1sInterval = setInterval(() => {
                  if (textIn1sSeconds > 0) {
                    textIn1sLength.value = (textIn1s.length / textIn1sSeconds).toFixed(2);
                  }
                  textIn1sSeconds += 0.2;
                }, 200);

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";

                async function readLine() {
                  const { done, value } = await reader.read();

                  if (done) {
                    // 请求成功后保存数据
                    saveToStorage();
                    clearInterval(textIn1sInterval);
                    textIn1sSeconds = 0;
                    textIn1s = "";
                    return;
                  }

                  buffer += decoder.decode(value, { stream: true });

                  // 按行分割处理
                  const lines = buffer.split("\n");
                  
                  // 重要，处理特殊场景下，返回的数据块不完整问题
                  if (lines.length > 1) {
                    buffer = lines.pop() || ''; // 保留不完整尾部
                  }

                  for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    resultJson.value += line + "\n";
                    scrollResultJsonToBottom();
                    if (line.startsWith("data: ")) {
                      const dataStr = line.slice(6).trim();

                      if (dataStr === "[DONE]") {
                        // 请求成功后保存数据
                        saveToStorage();
                        clearInterval(textIn1sInterval);
                        textIn1sSeconds = 0;
                        textIn1s = "";
                        return;
                      }

                      try {
                        const chunk = JSON.parse(dataStr);

                        if (chunk.choices == undefined) {
                          return;
                        }

                        if (chunk.choices[0].delta?.reasoning_content != null) {
                          resultText.value +=
                            chunk.choices[0].delta.reasoning_content;
                          textIn1s += chunk.choices[0].delta.reasoning_content;
                        } else if (chunk.choices[0].delta?.content != null) {
                          resultText.value += chunk.choices[0].delta.content;
                          textIn1s += chunk.choices[0].delta.content;
                        }
                        scrollResultTextToBottom();
                      } catch (e) {
                        console.warn("Failed to parse SSE data:", dataStr, e);
                      }
                    }
                  }

                  // 继续读取下一块
                  await readLine();
                }

                saveToStorage();
                await readLine();
              } else {
                const resData = await response.json();
                resultJson.value = JSON.stringify(resData, null, 2);

                if (resData.choices != undefined) {
                  resultText.value = resData.choices[0].message?.content || "";
                }

                // 请求成功后保存数据
                saveToStorage();
              }
            } catch (error) {
              console.error("Error:", error);
              resultJson.value = `请求出错: ${error.message}`;
              loading.value = false;
            } finally {
              loading.value = false;
            }
          };
          // 组件挂载时加载本地存储
          onMounted(() => {
            loadFromStorage();
            scrollResultJsonToBottom();
            scrollResultTextToBottom();
          });

          return {
            address,
            key,
            modelName,
            isStream,
            describeImg,
            question,
            resultJson,
            resultText,
            resultJsonTextarea,
            resultTextTextarea,
            showAddressTip,
            showModelNameTip,
            showQuestionTip,
            loading,
            testImage,
            isImgZoom1,
            textIn1sLength,
            handleImageUpload,
            sendRequest,
            toggleZoom1,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
