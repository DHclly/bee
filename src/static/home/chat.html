<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/static/redoc/favicon.png" />
    <link rel="stylesheet" href="/static/home/bulma.min.css" />
    <title>Chat</title>
  </head>
  <body>
    <div class="container is-fluid">
      <section class="hero is-warning">
        <div class="hero-body">
          <h1 class="title">对话补全 Chat</h1>
          <h2 class="subtitle">对话补全接口，提供模型问答能力</h2>
        </div>
      </section>
      <div class="columns is-desktop" style="margin-top: 20px">
        <div class="column">
          <div class="field">
            <label class="label">模型地址：</label>
            <div class="control">
              <input
                id="address"
                class="input is-warning"
                type="text"
                placeholder="http://localhost:8000/v1/chat/completions"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="notification is-warning" id="tip-address">
            请求地址不能为空
          </div>

          <div class="field">
            <label class="label">模型秘钥：</label>
            <div class="control">
              <input
                id="key"
                class="input is-warning"
                type="text"
                placeholder="sk-123456"
              />
            </div>
          </div>

          <div class="field">
            <label class="label">模型名称：</label>
            <div class="control">
              <input
                id="model-name"
                class="input is-warning"
                type="text"
                placeholder="qwen-max"
              />
            </div>
            <p class="help is-warning">
              常见对话模型：qwen3,qwen3-vl,deepseek-r1,GPT-5,GPT-4o
            </p>
          </div>
          <div class="notification is-warning" id="tip-model-name">
            模型名称不能为空
          </div>

          <div class="field">
            <label class="label">stream 流式输出：</label>
            <div class="control">
              <label class="radio">
                <input type="radio" name="stream" checked value="yes" />
                是
              </label>
              <label class="radio">
                <input type="radio" name="stream" value="no" />
                否
              </label>
            </div>
          </div>

          <div class="field">
            <label class="label">图片理解：</label>
            <div class="control">
              <label class="radio">
                <input type="radio" name="describe-img" value="yes" />
                是
              </label>
              <label class="radio">
                <input type="radio" name="describe-img" checked value="no" />
                否
              </label>
            </div>
          </div>

          <div class="field test-img">
            <label class="label">测试图片：</label>
            <div class="control">
              <figure
                class="image"
                style="width: 35px; height: 32px; border: 1px solid #000"
              >
                <img
                  src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAgACMDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3misjxPrv/CN+HrzVBZT3jW8TyLDCMbtqFzuboigKSSfoAWKqbeoz30Fuv9nWSXdw77Qss/kxoMElnbDEDjHyqxyRwBlgAXKKwNN17UL/AE/Ud2jeVqthdG0ktBdK0bMQjK4lwP3ZSRGJ27gNw2kgAyaLrV9e6pqGl6ppiWV5ZpFKDDc+fFNFJuCsrFVYENHIpBUdARkGgDbooooAxPGUE114G8QW9vE808um3KRxxqWZ2MTAAAckk9qp+OtW1fSdDg/sW1nkubu6jtXuIbV7k2UbZ3T+UoJfaBwOmSOvQ9PRQBzljLYJ4bvJbe31idHc/a5HtpoLuZiFDy4ZUckKRjyxwFCxj5VUV/CcE0Oqaq9tFqKaLMkD2zaipErzfOsp/efvyMLEAZueML8gWurooAKKKKAP/9k="
                />
              </figure>
            </div>
          </div>

          <div class="field">
            <label class="label">提问问题：</label>
            <div class="control">
              <textarea
                id="question"
                class="textarea is-warning"
                rows="4"
                placeholder="提问问题"
                spellcheck="false"
                autocomplete="off"
              >
苹果公司的产品有哪些？</textarea
              >
            </div>
          </div>
          <div class="notification is-warning" id="tip-question">
            提问问题不能为空
          </div>

          <div class="control is-expanded">
            <button id="send" class="button is-warning is-fullwidth">
              发起请求
            </button>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">返回结果(json or sse)：</label>
            <textarea
              id="result-json"
              class="textarea is-warning"
              rows="10"
              placeholder="输出结果"
              spellcheck="false"
              autocomplete="off"
            ></textarea>
          </div>
          <div class="field">
            <label class="label">返回结果(text)：</label>
            <textarea
              id="result-text"
              class="textarea is-warning"
              rows="10"
              placeholder="输出结果"
              spellcheck="false"
              autocomplete="off"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      const eleAddress = document.querySelector("#address");
      const eleKey = document.querySelector("#key");
      const eleModelName = document.querySelector("#model-name");
      const eleQuestion = document.querySelector("#question");
      const eleSend = document.querySelector("#send");
      const eleResultJson = document.querySelector("#result-json");
      const eleResultText = document.querySelector("#result-text");
      const eleTipAddress = document.querySelector("#tip-address");
      const eleTipModelName = document.querySelector("#tip-model-name");
      const eleTipQuestion = document.querySelector("#tip-question");
      const eleStream = document.querySelectorAll('input[name="stream"]');
      const eleDescribeImg = document.querySelectorAll(
        'input[name="describe-img"]'
      );

      const eleTestImg = document.querySelector(".test-img");

      eleAddress.value = `${location.origin}/v1/chat/completions`;
      eleModelName.value = "qwen3";
      eleQuestion.value = "苹果公司的产品有哪些？";

      if (
        "chat_address" in localStorage &&
        localStorage.getItem("chat_address").length > 0
      ) {
        eleAddress.value = localStorage.getItem("chat_address");
      }
      if (
        "chat_key" in localStorage &&
        localStorage.getItem("chat_key").length > 0
      ) {
        eleKey.value = localStorage.getItem("chat_key");
      }

      if (
        "chat_modelName" in localStorage &&
        localStorage.getItem("chat_modelName").length > 0
      ) {
        eleModelName.value = localStorage.getItem("chat_modelName");
      }

      if (
        "chat_question" in localStorage &&
        localStorage.getItem("chat_question").length > 0
      ) {
        eleQuestion.value = localStorage.getItem("chat_question");
      }

      if (
        "chat_result_json" in localStorage &&
        localStorage.getItem("chat_result_json").length > 0
      ) {
        eleResultJson.value = localStorage.getItem("chat_result_json");
      }

      if (
        "chat_result_text" in localStorage &&
        localStorage.getItem("chat_result_text").length > 0
      ) {
        eleResultText.value = localStorage.getItem("chat_result_text");
      }

      eleTestImg.style.display = "none";
      eleTipAddress.style.display = "none";
      eleTipModelName.style.display = "none";
      eleTipQuestion.style.display = "none";

      eleDescribeImg.forEach((item) => {
        item.addEventListener("click", () => {
          if (item.value == "yes") {
            eleTestImg.style.display = "block";
            eleQuestion.value = "描述一下图片内容";
          } else {
            eleTestImg.style.display = "none";
            eleQuestion.value = "mac 是苹果公司的产品么？";
          }
        });
      });

      eleSend.addEventListener("click", () => {
        if (eleAddress.value.length === 0) {
          eleTipAddress.style.display = "block";
          return;
        }

        if (eleModelName.value.length === 0) {
          eleTipModelName.style.display = "block";
          return;
        }

        if (eleQuestion.value.length === 0) {
          eleTipQuestion.style.display = "block";
          return;
        }

        eleTipAddress.style.display = "none";
        eleTipModelName.style.display = "none";
        eleTipQuestion.style.display = "none";

        localStorage.setItem("chat_address", eleAddress.value);
        localStorage.setItem("chat_key", eleKey.value);
        localStorage.setItem("chat_modelName", eleModelName.value);
        localStorage.setItem("chat_question", eleQuestion.value);

        let isStream = false;
        let isDescribeImg = false;
        eleStream.forEach((item) => {
          if (item.checked) {
            isStream = item.value == "yes";
          }
        });

        eleDescribeImg.forEach((item) => {
          if (item.checked) {
            isDescribeImg = item.value == "yes";
          }
        });

        const content = [];
        if (isDescribeImg) {
          content.push({
            type: "image_url",
            image_url: {
              url: eleTestImg.src,
            },
          });
        }

        content.push({ type: "text", text: eleQuestion.value });

        const req1 = fetch(eleAddress.value, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${eleKey.value}`,
          },
          body: JSON.stringify({
            stream: isStream,
            model: eleModelName.value,
            top_p: 1,
            max_tokens: 4096,
            messages: [
              {
                role: "user",
                content: content,
              },
            ],
          }),
        });

        if (isStream) {
          eleResultJson.value = "";
          eleResultText.value = "";

          let isScrollScheduled = false;
          function scheduleScroll(element) {
            if (!isScrollScheduled) {
              isScrollScheduled = true;
              requestAnimationFrame(() => {
                element.scrollTop = element.scrollHeight;
                isScrollScheduled = false;
              });
            }
          }

          let isScrollScheduled2 = false;
          function scheduleScroll2(element) {
            if (!isScrollScheduled2) {
              isScrollScheduled2 = true;
              requestAnimationFrame(() => {
                element.scrollTop = element.scrollHeight;
                isScrollScheduled2 = false;
              });
            }
          }

          req1
            .then((response) => {
              if (!response.ok) {
                return response.text().then(function (text) {
                  eleResultJson.value = "HTTP " + response.status + ": " + text;
                  return;
                });
              }

              if (!response.body) {
                eleResultJson.value =
                  "ReadableStream not supported in this browser";
                return;
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder("utf-8");
              let buffer = "";

              function readLine() {
                return reader.read().then(function (result) {
                  if (result.done) {
                    return;
                  }

                  buffer += decoder.decode(result.value, { stream: true });

                  // 按行分割处理
                  const lines = buffer.split("\n");
                  buffer = lines.pop() || ""; // 保留未完成的最后一行

                  for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    eleResultJson.value += line + "\n";
                    scheduleScroll(eleResultJson);

                    if (line.startsWith("data: ")) {
                      var dataStr = line.slice(6).trim();

                      if (dataStr === "[DONE]") {
                        localStorage.setItem("chat_result_json", eleResultJson.value);
                        localStorage.setItem("chat_result_text", eleResultText.value);
                        return;
                      }

                      try {
                        var chunk = JSON.parse(dataStr);

                        if(chunk.choices == undefined){
                            return;
                        }

                        if (chunk.choices[0].delta.reasoning_content != null) {
                          eleResultText.value +=
                            chunk.choices[0].delta.reasoning_content;
                        } else {
                          eleResultText.value += chunk.choices[0].delta.content;
                        }
                        scheduleScroll2(eleResultText);
                      } catch (e) {
                        console.warn("Failed to parse SSE data:", dataStr, e);
                      }
                    }
                  }

                  // 继续读取下一块
                  readLine();
                });
              }

              readLine();
            })
            .catch((error) => console.error("Error:", error));
        } else {
          req1
            .then((response) => response.json())
            .then((resData) => {
              eleResultJson.value = JSON.stringify(resData, null, 2);
              if (resData.choices == undefined) {
                return;
              }

              localStorage.setItem("chat_result_json", eleResultJson.value);

              eleResultText.value = resData.choices[0].message.content;
              localStorage.setItem("chat_result_text", eleResultText.value);
            })
            .catch((error) => console.error("Error:", error));
        }
      });
    </script>
  </body>
</html>
