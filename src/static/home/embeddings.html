<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/static/redoc/favicon.png" />
    <link rel="stylesheet" href="/static/home/bulma.min.css" />
    <style>
      .column-title {
        font-size: 26px;
        font-weight: bold;
      }
    </style>
    <title>Embeddings</title>
  </head>
  <body>
    <div class="container is-fluid" id="app">
      <section class="hero is-warning">
        <div class="hero-body">
          <h1 class="title">向量化 Embeddings</h1>
          <h2 class="subtitle">
            将输入的文本列表转换为对应的嵌入向量（embeddings），支持多语言和长文本。
          </h2>
        </div>
      </section>
      <div class="columns is-desktop" style="margin-top: 20px">
        <div class="column">
          <h2 class="column-title">请求参数：</h2>
          <div class="field">
            <label class="label">模型地址：</label>
            <div class="control">
              <input
                v-model="address"
                class="input is-warning"
                type="text"
                placeholder="http://localhost:8000/v1/embeddings"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="notification is-warning" v-show="showAddressTip">
            请求地址不能为空
          </div>

          <div class="field">
            <label class="label">模型秘钥：</label>
            <div class="control">
              <input
                v-model="key"
                class="input is-warning"
                type="text"
                placeholder="sk-123456"
              />
            </div>
          </div>

          <div class="field">
            <label class="label">模型名称：</label>
            <div class="control">
              <input
                v-model="modelName"
                class="input is-warning"
                type="text"
                placeholder="bge-m3"
              />
            </div>
            <p class="help is-warning">
              常见向量模型：bge-m3、bge-base-zh-v1.5、qwen3-embedding
            </p>
          </div>
          <div class="notification is-warning" v-show="showModelNameTip">
            模型名称不能为空
          </div>
          <div class="field">
            <label class="label">向量化文本列表：</label>
          </div>

          <div
            v-for="(input, index) in inputs"
            :key="index"
            class="field has-addons"
            style="align-items: center"
          >
            <p class="control">
              <a class="button is-static"> {{ index + 1 }}. </a>
            </p>
            <div class="control is-expanded">
              <input
                v-model="input.value"
                class="input is-warning"
                type="text"
                :placeholder="input.placeholder"
              />
            </div>
            <p
              class="control"
              style="margin-left: 10px"
              v-if="inputs.length > 1"
            >
              <button
                class="delete is-medium"
                @click="inputs.splice(index, 1)"
              ></button>
            </p>
          </div>

          <div
            class="field is-grouped is-grouped-right"
            style="margin-top: 10px"
          >
            <p class="control">
              <button @click="addInput" class="button is-warning is-outlined">
                新增向量文本
              </button>
            </p>
          </div>

          <div class="notification is-warning" v-show="showInputTip">
            至少有一行向量化文本
          </div>
          <div class="control is-expanded">
            <button
              @click="sendRequest"
              class="button is-warning is-fullwidth"
              :disabled="loading"
              :class="{ 'is-loading': loading }"
            >
              发起请求
            </button>
          </div>
        </div>
        <div class="column">
          <h2 class="column-title">返回结果：</h2>
          <div class="field">
            <label class="label">模型维度：</label>
            <div class="control">
              <input
                v-model.number="modelDimensions"
                class="input is-warning"
                type="number"
                placeholder="0"
                readonly
              />
            </div>
          </div>

          <div class="field">
            <label class="label">JSON：</label>
            <textarea
              ref="resultJsonTextarea"
              v-model="result"
              class="textarea is-warning"
              rows="20"
              placeholder="输出结果"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script src="/static/home/vue3.global.prod.js"></script>
    <script>
      const { createApp, ref, onMounted, reactive } = Vue;

      createApp({
        setup() {
          // 响应式数据
          const address = ref("");
          const key = ref("");
          const modelName = ref("");
          const result = ref("");
          const resultJsonTextarea = ref(null);
          const modelDimensions = ref(0);
          const showAddressTip = ref(false);
          const showModelNameTip = ref(false);
          const showInputTip = ref(false);
          const loading = ref(false);

          // 使用 reactive 创建响应式数组
          const inputs = reactive([
            {
              value: "",
              placeholder: "请输入文本",
            },
            {
              value: "",
              placeholder: "请输入文本",
            },
            {
              value: "",
              placeholder: "请输入文本",
            },
          ]);

          // 本地存储键名映射
          const storageKeys = {
            address: "embeddings_address",
            key: "embeddings_key",
            modelName: "embeddings_modelName",
            inputs: "embeddings_inputs", // 存储所有输入框数据
            modelDimensions: "embeddings_modelDimensions",
            result: "embeddings_result",
          };

          // 从本地存储加载数据
          const loadFromStorage = () => {
            address.value =
              localStorage.getItem(storageKeys.address) ||
              `${location.origin}/v1/embeddings`;
            key.value = localStorage.getItem(storageKeys.key) || "";
            modelName.value =
              localStorage.getItem(storageKeys.modelName) || "bge-m3";

            // 加载输入框数据
            const savedInputs = localStorage.getItem(storageKeys.inputs);
            if (savedInputs) {
              const parsedInputs = JSON.parse(savedInputs);
              // 清空现有输入框
              inputs.length = 0;
              // 添加保存的输入框数据
              parsedInputs.forEach((input) => {
                inputs.push(input);
              });
            } else {
              // 如果没有保存的数据，使用默认值
              inputs.length = 0;
              inputs.push(
                {
                  value:
                    "Apple 是一家伟大的公司，他们的主要产品有 iPhone、iPad 和 Mac。",
                  placeholder: "请输入文本",
                },
                {
                  value:
                    "Microsoft 是一家伟大的公司，他们的主要产品有 Windows、Xbox 和 Surface。",
                  placeholder: "请输入文本",
                },
                {
                  value:
                    "OpenAI 是一家伟大的公司，他们的主要产品有 GPT-3、GPT-4o、GPT-5。",
                  placeholder: "请输入文本",
                }
              );
            }

            modelDimensions.value =
              parseInt(localStorage.getItem(storageKeys.modelDimensions)) || 0;
            result.value = localStorage.getItem(storageKeys.result) || "";
          };

          // 只在请求成功后保存数据到本地存储
          const saveToStorage = () => {
            localStorage.setItem(storageKeys.address, address.value);
            localStorage.setItem(storageKeys.key, key.value);
            localStorage.setItem(storageKeys.modelName, modelName.value);
            localStorage.setItem(storageKeys.inputs, JSON.stringify(inputs));
            localStorage.setItem(
              storageKeys.modelDimensions,
              modelDimensions.value.toString()
            );
            localStorage.setItem(storageKeys.result, result.value);
          };

          // 添加新的输入框
          const addInput = () => {
            inputs.push({
              value: "",
              placeholder: "请输入文本",
            });
          };

          const scrollTextareaToBottom = (refTextarea) => {
            let scheduled = false; // ← 改名更准确

            const innerScrollTextareaToBottom = () => {
              if (scheduled) {
                return;
              }
              scheduled = true;

              requestAnimationFrame(() => {
                if (refTextarea.value) {
                  refTextarea.value.scrollTop = refTextarea.value.scrollHeight;
                }
                scheduled = false;
              });
            };

            return innerScrollTextareaToBottom;
          };

          const scrollResultToBottom = scrollTextareaToBottom(resultJsonTextarea);

          // 发送请求
          const sendRequest = async () => {
            // 重置提示信息
            showAddressTip.value = false;
            showModelNameTip.value = false;
            showInputTip.value = false;

            // 验证输入
            if (!address.value.trim()) {
              showAddressTip.value = true;
              return;
            }

            if (!modelName.value.trim()) {
              showModelNameTip.value = true;
              return;
            }

            // 检查是否有至少一个非空输入
            const hasNonEmptyInput = inputs.some((input) => input.value.trim());
            if (!hasNonEmptyInput) {
              showInputTip.value = true;
              return;
            }

            loading.value = true;

            try {
              // 过滤掉空的输入
              const input = inputs
                .map((input) => input.value.trim())
                .filter((value) => value);

              const response = await fetch(address.value, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${key.value}`,
                },
                body: JSON.stringify({
                  model: modelName.value,
                  input: input,
                }),
              });

              const resData = await response.json();

              if (resData.data === undefined) {
                result.value = JSON.stringify(resData, null, 2);
              } else {
                let data = resData.data;
                if (data.length > 0) {
                  modelDimensions.value = data[0].embedding.length;

                  // 为了显示目的，截取向量的前5个值并添加省略号
                  data.forEach((e) => {
                    e.embedding = [...e.embedding.slice(0, 5), "..."];
                  });
                }

                let json_text = JSON.stringify(resData, null, 2);
                json_text = json_text.replace(/"\.\.\."/g, "...");
                result.value = json_text;

                // 只有在请求成功后才保存数据到本地存储
                saveToStorage();
                scrollResultToBottom();
              }
            } catch (error) {
              console.error("Error:", error);
              result.value = `请求出错: ${error.message}`;
            } finally {
              loading.value = false;
            }
          };

          // 组件挂载时加载本地存储
          onMounted(() => {
            loadFromStorage();
            scrollResultToBottom();
          });

          return {
            address,
            key,
            modelName,
            inputs,
            result,
            resultJsonTextarea,
            modelDimensions,
            showAddressTip,
            showModelNameTip,
            showInputTip,
            loading,
            addInput,
            sendRequest,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
