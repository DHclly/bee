<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/static/redoc/favicon.png" />
    <link rel="stylesheet" href="/static/home/bulma.min.css" />
    <title>Rerank</title>
  </head>
  <body>
    <div class="container is-fluid">
      <section class="hero is-warning">
        <div class="hero-body">
          <h1 class="title">文本重排 Rerank</h1>
          <h2 class="subtitle">
            对给定查询（query）与一组候选文档（documents）进行语义相关性重排序。
          </h2>
        </div>
      </section>
      <div class="columns is-desktop" style="margin-top: 20px">
        <div class="column">
          <div class="field">
            <label class="label">模型地址：</label>
            <div class="control">
              <input
                id="address"
                class="input is-warning"
                type="text"
                placeholder="http://localhost:8000/v1/rerank"
              />
            </div>
          </div>
          <div class="notification is-warning" id="tip-address">
            请求地址不能为空
          </div>

          <div class="field">
            <label class="label">模型秘钥：</label>
            <div class="control">
              <input
                id="key"
                class="input is-warning"
                type="text"
                placeholder="sk-123456"
              />
            </div>
          </div>

          <div class="field">
            <label class="label">模型名称：</label>
            <div class="control">
              <input
                id="model-name"
                class="input is-warning"
                type="email"
                placeholder="bge-reranker-v2-m3"
              />
            </div>
            <p class="help is-warning">常见向量模型：bge-reranker-v2-m3</p>
          </div>
          <div class="notification is-warning" id="tip-model-name">
            模型名称不能为空
          </div>

          <div class="field">
            <label class="label">提问问题：</label>
            <div class="control">
              <input
                id="question"
                class="input is-warning"
                type="email"
                placeholder="苹果公司的产品有哪些？"
              />
            </div>
          </div>
          <div class="notification is-warning" id="tip-question">
            提问问题不能为空
          </div>

          <div class="field">
            <label class="label">打分重排文本列表：</label>
          </div>

          <div class="field has-addons">
            <p class="control">
              <a class="button is-static"> 1. </a>
            </p>
            <div class="control is-expanded">
              <input
                id="input-1"
                class="input is-warning"
                type="text"
                placeholder="Apple 是一家伟大的公司，他们的主要产品有 iPhone、iPad 和 Mac。"
              />
            </div>
          </div>

          <div class="field has-addons">
            <p class="control">
              <a class="button is-static"> 2. </a>
            </p>
            <div class="control is-expanded">
              <input
                id="input-2"
                class="input is-warning"
                type="text"
                placeholder="Microsoft 是一家伟大的公司，他们的主要产品有 Windows、Xbox 和 Surface。"
              />
            </div>
          </div>

          <div class="field has-addons">
            <p class="control">
              <a class="button is-static"> 3. </a>
            </p>
            <div class="control is-expanded">
              <input
                id="input-3"
                class="input is-warning"
                type="text"
                placeholder="OpenAI 是一家伟大的公司，他们的主要产品有 GPT-3、GPT-4o、GPT-5。"
              />
            </div>
          </div>
          <div class="notification is-warning" id="tip-input">
            至少要有一行重排文本
          </div>
          <div class="control is-expanded">
            <button id="send" class="button is-warning is-fullwidth">
              发起请求
            </button>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">模型维度：</label>
            <div class="control">
              <input
                id="model-dimensions"
                class="input is-warning"
                type="number"
                placeholder="0"
                disabled
              />
            </div>
          </div>

          <div class="field">
            <label class="label">返回结果：</label>
            <textarea
              id="result"
              class="textarea is-warning"
              rows="20"
              placeholder="输出结果"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      const address = document.querySelector("#address");
      const key = document.querySelector("#key");
      const modelName = document.querySelector("#model-name");
      const question = document.querySelector("#question");
      const input1 = document.querySelector("#input-1");
      const input2 = document.querySelector("#input-2");
      const input3 = document.querySelector("#input-3");
      const send = document.querySelector("#send");
      const result = document.querySelector("#result");
      const modelDimensions = document.querySelector("#model-dimensions");
      const tipAddress = document.querySelector("#tip-address");
      const tipModelName = document.querySelector("#tip-model-name");
      const tipQuestion = document.querySelector("#tip-question");
      const tipInput = document.querySelector("#tip-input");

      address.value = `${location.origin}/v1/rerank`;
      modelName.value = "bge-reranker-v2-m3";
      question.value = "苹果公司的产品有哪些？";
      input1.value =
        "Apple 是一家伟大的公司，他们的主要产品有 iPhone、iPad 和 Mac。";
      input2.value =
        "Microsoft 是一家伟大的公司，他们的主要产品有 Windows、Xbox 和 Surface。";
      input3.value =
        "OpenAI 是一家伟大的公司，他们的主要产品有 GPT-3、GPT-4o、GPT-5。";

      if (
        "rerank_address" in localStorage &&
        localStorage.getItem("rerank_address").length > 0
      ) {
        address.value = localStorage.getItem("rerank_address");
      }
      if (
        "rerank_key" in localStorage &&
        localStorage.getItem("rerank_key").length > 0
      ) {
        key.value = localStorage.getItem("rerank_key");
      }

      if (
        "rerank_modelName" in localStorage &&
        localStorage.getItem("rerank_modelName").length > 0
      ) {
        modelName.value = localStorage.getItem("rerank_modelName");
      }

      if (
        "rerank_question" in localStorage &&
        localStorage.getItem("rerank_question").length > 0
      ) {
        question.value = localStorage.getItem("rerank_question");
      }

      if (
        "rerank_input1" in localStorage &&
        localStorage.getItem("rerank_input1").length > 0
      ) {
        input1.value = localStorage.getItem("rerank_input1");
      }

      if (
        "rerank_input2" in localStorage &&
        localStorage.getItem("rerank_input2").length > 0
      ) {
        input2.value = localStorage.getItem("rerank_input2");
      }

      if (
        "rerank_input3" in localStorage &&
        localStorage.getItem("rerank_input3").length > 0
      ) {
        input3.value = localStorage.getItem("rerank_input3");
      }

      if (
        "rerank_modelDimensions" in localStorage &&
        localStorage.getItem("rerank_modelDimensions").length > 0
      ) {
        modelDimensions.value = localStorage.getItem("rerank_modelDimensions");
      }

      if (
        "rerank_result" in localStorage &&
        localStorage.getItem("rerank_result").length > 0
      ) {
        result.value = localStorage.getItem("rerank_result");
      }

      tipAddress.style.display = "none";
      tipModelName.style.display = "none";
      tipQuestion.style.display = "none";
      tipInput.style.display = "none";

      send.addEventListener("click", () => {
        if (address.value.length === 0) {
          tipAddress.style.display = "block";
          return;
        }

        if (modelName.value.length === 0) {
          tipModelName.style.display = "block";
          return;
        }

        if (question.value.length === 0) {
          tipQuestion.style.display = "block";
          return;
        }

        if (
          input1.value.length === 0 &&
          input2.value.length === 0 &&
          input3.value.length === 0
        ) {
          tipInput.style.display = "block";
          return;
        }

        const documents = [];
        if (input1.value.length > 0) {
          documents.push(input1.value);
        }
        if (input2.value.length > 0) {
          documents.push(input2.value);
        }
        if (input3.value.length > 0) {
          documents.push(input3.value);
        }

        tipAddress.style.display = "none";
        tipModelName.style.display = "none";
        tipQuestion.style.display = "none";
        tipInput.style.display = "none";

        localStorage.setItem("rerank_address", address.value);
        localStorage.setItem("rerank_key", key.value);
        localStorage.setItem("rerank_modelName", modelName.value);
        localStorage.setItem("rerank_question", question.value);
        localStorage.setItem("rerank_input1", input1.value);
        localStorage.setItem("rerank_input2", input2.value);
        localStorage.setItem("rerank_input3", input3.value);

        fetch(address.value, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${key.value}`,
          },
          body: JSON.stringify({
            model: modelName.value,
            top_n: documents.length,
            query: question.value,
            documents: documents,
          }),
        })
          .then((response) => response.json())
          .then((res_data) => {
            if (res_data.data == undefined) {
              result.value = JSON.stringify(res_data, null, 2);
              return;
            }

            let data = res_data.data;
            modelDimensions.value = data[0].embedding.length;
            data.forEach((e) => {
              e.embedding = e.embedding.slice(0, 5);
              e.embedding.push("...");
            });
            let json_text = JSON.stringify(res_data, null, 2);
            json_text = json_text.replace(/\"...\"/g, "...");
            result.value = json_text;

            localStorage.setItem(
              "rerank_modelDimensions",
              modelDimensions.value
            );
            localStorage.setItem("rerank_result", result.value);
          })
          .catch((error) => console.error("Error:", error));
      });
    </script>
  </body>
</html>
