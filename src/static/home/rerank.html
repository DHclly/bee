<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/static/redoc/favicon.png" />
    <link rel="stylesheet" href="/static/home/bulma.min.css" />
    <style>
      /* .visual .result-item .progress {
        height: 30px;
      }

      .visual .result-item .tag {
        position: relative;
        top: -40px;
        left: 10px;
      } */

      .tabs-result li span {
        color: var(--bulma-warning);
      }

      .tabs-result li.is-active span {
        color: var(--bulma-link);
        font-weight: bold;
      }
    </style>
    <title>Rerank</title>
  </head>
  <body>
    <div class="container is-fluid">
      <section class="hero is-warning">
        <div class="hero-body">
          <h1 class="title">文本重排 Rerank</h1>
          <h2 class="subtitle">
            对给定查询（query）与一组候选文档（documents）进行语义相关性重排序。
          </h2>
        </div>
      </section>
      <div class="columns is-desktop" style="margin-top: 20px">
        <div class="column">
          <div class="field">
            <label class="label">模型地址：</label>
            <div class="control">
              <input
                id="address"
                class="input is-warning"
                type="text"
                placeholder="http://localhost:8000/v1/rerank"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="notification is-warning" id="tip-address">
            请求地址不能为空
          </div>

          <div class="field">
            <label class="label">模型秘钥：</label>
            <div class="control">
              <input
                id="key"
                class="input is-warning"
                type="text"
                placeholder="sk-123456"
              />
            </div>
          </div>

          <div class="field">
            <label class="label">模型名称：</label>
            <div class="control">
              <input
                id="model-name"
                class="input is-warning"
                type="email"
                placeholder="bge-reranker-v2-m3"
              />
            </div>
            <p class="help is-warning">常见向量模型：bge-reranker-v2-m3</p>
          </div>
          <div class="notification is-warning" id="tip-model-name">
            模型名称不能为空
          </div>

          <div class="field">
            <label class="label">提问问题：</label>
            <div class="control">
              <input
                id="question"
                class="input is-warning"
                type="email"
                placeholder="苹果公司的产品有哪些？"
              />
            </div>
          </div>
          <div class="notification is-warning" id="tip-question">
            提问问题不能为空
          </div>

          <div class="field">
            <label class="label">打分重排文本列表：</label>
          </div>

          <div class="field has-addons">
            <p class="control">
              <a class="button is-static"> 1. </a>
            </p>
            <div class="control is-expanded">
              <input
                id="input-1"
                class="input is-warning"
                type="text"
                placeholder="Apple 是一家伟大的公司，他们的主要产品有 iPhone、iPad 和 Mac。"
              />
            </div>
          </div>

          <div class="field has-addons">
            <p class="control">
              <a class="button is-static"> 2. </a>
            </p>
            <div class="control is-expanded">
              <input
                id="input-2"
                class="input is-warning"
                type="text"
                placeholder="Microsoft 是一家伟大的公司，他们的主要产品有 Windows、Xbox 和 Surface。"
              />
            </div>
          </div>

          <div class="field has-addons">
            <p class="control">
              <a class="button is-static"> 3. </a>
            </p>
            <div class="control is-expanded">
              <input
                id="input-3"
                class="input is-warning"
                type="text"
                placeholder="OpenAI 是一家伟大的公司，他们的主要产品有 GPT-3、GPT-4o、GPT-5。"
              />
            </div>
          </div>
          <div class="notification is-warning" id="tip-input">
            至少要有一行重排文本
          </div>
          <div class="control is-expanded">
            <button id="send" class="button is-warning is-fullwidth">
              发起请求
            </button>
          </div>
        </div>
        <div class="column">
          <div class="tabs tabs-result is-centered is-boxed is-warning">
            <ul>
              <li class="is-active">
                <a>
                  <span>可视化</span>
                </a>
              </li>
              <li>
                <a>
                  <span>JSON 数据</span>
                </a>
              </li>
            </ul>
          </div>
          <div id="json-data">
            <div class="field">
              <label class="label">返回结果：</label>
              <textarea
                id="result"
                class="textarea is-warning"
                rows="20"
                placeholder="输出结果"
              ></textarea>
            </div>
          </div>
          <div id="visual" class="visual">
            <div class="field">
              <label class="label">返回结果：</label>
            </div>
            <div class="result-list" id="result-list"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const eleAddress = document.querySelector("#address");
      const eleKey = document.querySelector("#key");
      const eleModelName = document.querySelector("#model-name");
      const eleQuestion = document.querySelector("#question");
      const eleInput1 = document.querySelector("#input-1");
      const eleInput2 = document.querySelector("#input-2");
      const eleInput3 = document.querySelector("#input-3");
      const eleSend = document.querySelector("#send");
      const eleResult = document.querySelector("#result");
      const eleTipAddress = document.querySelector("#tip-address");
      const eleTipModelName = document.querySelector("#tip-model-name");
      const eleTipQuestion = document.querySelector("#tip-question");
      const eleTipInput = document.querySelector("#tip-input");
      const eleJsonData = document.querySelector("#json-data");
      const eleVisual = document.querySelector("#visual");
      const eleTabsVisual = document.querySelector(".tabs-result li:nth-child(1)");
      const eleTabsJsonData = document.querySelector(
        ".tabs-result li:nth-child(2)"
      );
      const eleResultList = document.querySelector("#result-list");

      eleAddress.value = `${location.origin}/v1/rerank`;
      eleModelName.value = "bge-reranker-v2-m3";
      eleQuestion.value = "苹果公司的产品有哪些？";
      eleInput1.value =
        "Apple 是一家伟大的公司，他们的主要产品有 iPhone、iPad 和 Mac。";
      eleInput2.value =
        "Microsoft 是一家伟大的公司，他们的主要产品有 Windows、Xbox 和 Surface。";
      eleInput3.value =
        "OpenAI 是一家伟大的公司，他们的主要产品有 GPT-3、GPT-4o、GPT-5。";

      eleVisual.style.display = "block";
      eleJsonData.style.display = "none";

      if (
        "rerank_address" in localStorage &&
        localStorage.getItem("rerank_address").length > 0
      ) {
        eleAddress.value = localStorage.getItem("rerank_address");
      }
      if (
        "rerank_key" in localStorage &&
        localStorage.getItem("rerank_key").length > 0
      ) {
        eleKey.value = localStorage.getItem("rerank_key");
      }

      if (
        "rerank_modelName" in localStorage &&
        localStorage.getItem("rerank_modelName").length > 0
      ) {
        eleModelName.value = localStorage.getItem("rerank_modelName");
      }

      if (
        "rerank_question" in localStorage &&
        localStorage.getItem("rerank_question").length > 0
      ) {
        eleQuestion.value = localStorage.getItem("rerank_question");
      }

      if (
        "rerank_input1" in localStorage &&
        localStorage.getItem("rerank_input1").length > 0
      ) {
        eleInput1.value = localStorage.getItem("rerank_input1");
      }

      if (
        "rerank_input2" in localStorage &&
        localStorage.getItem("rerank_input2").length > 0
      ) {
        eleInput2.value = localStorage.getItem("rerank_input2");
      }

      if (
        "rerank_input3" in localStorage &&
        localStorage.getItem("rerank_input3").length > 0
      ) {
        eleInput3.value = localStorage.getItem("rerank_input3");
      }

      if (
        "rerank_result" in localStorage &&
        localStorage.getItem("rerank_result").length > 0
      ) {
        eleResult.value = localStorage.getItem("rerank_result");
        renderResult(JSON.parse(eleResult.value));
      }

      eleTipAddress.style.display = "none";
      eleTipModelName.style.display = "none";
      eleTipQuestion.style.display = "none";
      eleTipInput.style.display = "none";

      eleSend.addEventListener("click", () => {
        if (eleAddress.value.length === 0) {
          eleTipAddress.style.display = "block";
          return;
        }

        if (eleModelName.value.length === 0) {
          eleTipModelName.style.display = "block";
          return;
        }

        if (eleQuestion.value.length === 0) {
          eleTipQuestion.style.display = "block";
          return;
        }

        if (
          eleInput1.value.length === 0 &&
          eleInput2.value.length === 0 &&
          eleInput3.value.length === 0
        ) {
          eleTipInput.style.display = "block";
          return;
        }

        const documents = [];
        if (eleInput1.value.length > 0) {
          documents.push(eleInput1.value);
        }
        if (eleInput2.value.length > 0) {
          documents.push(eleInput2.value);
        }
        if (eleInput3.value.length > 0) {
          documents.push(eleInput3.value);
        }

        eleTipAddress.style.display = "none";
        eleTipModelName.style.display = "none";
        eleTipQuestion.style.display = "none";
        eleTipInput.style.display = "none";

        localStorage.setItem("rerank_address", eleAddress.value);
        localStorage.setItem("rerank_key", eleKey.value);
        localStorage.setItem("rerank_modelName", eleModelName.value);
        localStorage.setItem("rerank_question", eleQuestion.value);
        localStorage.setItem("rerank_input1", eleInput1.value);
        localStorage.setItem("rerank_input2", eleInput2.value);
        localStorage.setItem("rerank_input3", eleInput3.value);

        fetch(eleAddress.value, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${eleKey.value}`,
          },
          body: JSON.stringify({
            model: eleModelName.value,
            top_n: documents.length,
            query: eleQuestion.value,
            documents: documents,
          }),
        })
          .then((response) => response.json())
          .then((res_data) => {
            eleResult.value = JSON.stringify(res_data, null, 2);
            if (res_data.results == undefined) {
              eleTabsJsonData.classList.add("is-active");
              eleTabsVisual.classList.remove("is-active");
              eleVisual.style.display = "none";
              eleJsonData.style.display = "block";
              return;
            }
            renderResult(res_data);
            localStorage.setItem("rerank_result", eleResult.value);
          })
          .catch((error) => console.error("Error:", error));
      });

      eleTabsVisual.addEventListener("click", () => {
        eleTabsVisual.classList.add("is-active");
        eleTabsJsonData.classList.remove("is-active");
        eleVisual.style.display = "block";
        eleJsonData.style.display = "none";
      });

      eleTabsJsonData.addEventListener("click", () => {
        eleTabsJsonData.classList.add("is-active");
        eleTabsVisual.classList.remove("is-active");
        eleVisual.style.display = "none";
        eleJsonData.style.display = "block";
      });

      function renderResult(jsonData) {
        eleResultList.innerHTML = "";
        let newHtml = "";
        jsonData.results.forEach((item, index) => {
          const score = item.relevance_score;
          let percent = (score * 100).toFixed(2);
          if (percent < 1) {
            percent = 1;
          }
          newHtml += `
                <div class="result-item">
                ${index > 0 ? `<hr/>` : ``}
                <div class="field has-addons">
                  <p class="control">
                    <a class="button is-static"> ${index + 1}. </a>
                  </p>
                  <div class="control is-expanded">
                    <input
                      class="input is-warning"
                      type="text"
                      value="${item.document.text}"
                      readonly
                    />
                  </div>
                </div>
                <div class="field">
                  <progress class="progress is-warning" value="${percent}" min="1" max="100">
                    ${percent}%
                  </progress>
                </div>
                <div class="field" style="margin-bottom: 12px;">
                  <span class="tag is-warning is-light"
                    >分数：<span class="score">${score.toFixed(5)}</span></span
                  >
                </div>
              </div>
            `;
        });
        eleResultList.innerHTML = newHtml;
      }
    </script>
  </body>
</html>
