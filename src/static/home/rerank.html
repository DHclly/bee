<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/static/redoc/favicon.png" />
    <link rel="stylesheet" href="/static/home/bulma.min.css" />
    <style>
      .tabs-result li span {
        color: var(--bulma-warning);
      }

      .tabs-result li.is-active span {
        color: var(--bulma-link);
        font-weight: bold;
      }

      .column-title {
        font-size: 26px;
        font-weight: bold;
      }
    </style>
    <title>Rerank</title>
  </head>
  <body>
    <div class="container is-fluid" id="app">
      <section class="hero is-warning">
        <div class="hero-body">
          <h1 class="title">文本重排 Rerank</h1>
          <h2 class="subtitle">
            对给定查询（query）与一组候选文档（documents）进行语义相关性重排序。
          </h2>
        </div>
      </section>
      <div class="columns is-desktop" style="margin-top: 20px">
        <div class="column">
          <h2 class="column-title">请求参数：</h2>
          <div class="field">
            <label class="label">模型地址：</label>
            <div class="control">
              <input
                v-model="address"
                class="input is-warning"
                type="text"
                placeholder="http://localhost:8000/v1/rerank"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="notification is-warning" v-show="showAddressTip">
            请求地址不能为空
          </div>

          <div class="field">
            <label class="label">模型秘钥：</label>
            <div class="control">
              <input
                v-model="key"
                class="input is-warning"
                type="text"
                placeholder="sk-123456"
              />
            </div>
          </div>

          <div class="field">
            <label class="label">模型名称：</label>
            <div class="control">
              <input
                v-model="modelName"
                class="input is-warning"
                type="text"
                placeholder="bge-reranker-v2-m3"
              />
            </div>
            <p class="help is-warning">常见重排模型：bge-reranker-v2-m3</p>
          </div>
          <div class="notification is-warning" v-show="showModelNameTip">
            模型名称不能为空
          </div>

          <div class="field">
            <label class="label">提问问题：</label>
            <div class="control">
              <input
                v-model="question"
                class="input is-warning"
                type="text"
                placeholder="苹果公司的产品有哪些？"
              />
            </div>
          </div>
          <div class="notification is-warning" v-show="showQuestionTip">
            提问问题不能为空
          </div>

          <div class="field">
            <label class="label">打分重排文本列表：</label>
          </div>

          <div
            v-for="(input, index) in inputs"
            :key="index"
            class="field has-addons"
          >
            <p class="control">
              <a class="button is-static"> {{ index + 1 }}. </a>
            </p>
            <div class="control is-expanded">
              <input
                v-model="input.value"
                class="input is-warning"
                type="text"
                :placeholder="input.placeholder"
              />
            </div>
            <p
              class="control"
              style="margin-left: 10px"
              v-if="inputs.length > 1"
            >
              <button
                class="delete is-medium"
                @click="inputs.splice(index, 1)"
              ></button>
            </p>
          </div>

          <div
            class="field is-grouped is-grouped-right"
            style="margin-top: 10px"
          >
            <p class="control">
              <button @click="addInput" class="button is-warning is-outlined">
                新增重排文本
              </button>
            </p>
          </div>

          <div class="notification is-warning" v-show="showInputTip">
            至少要有一行重排文本
          </div>
          <div class="control is-expanded">
            <button
              @click="sendRequest"
              class="button is-warning is-fullwidth"
              :disabled="loading"
              :class="{ 'is-loading': loading }"
            >
              发起请求
            </button>
          </div>
        </div>
        <div class="column">
          <h2 class="column-title">返回结果：</h2>
          <div class="tabs tabs-result is-centered is-boxed is-warning">
            <ul>
              <li
                :class="{ 'is-active': activeTab === 'visual' }"
                @click="switchTab('visual')"
              >
                <a>
                  <span>可视化</span>
                </a>
              </li>
              <li
                :class="{ 'is-active': activeTab === 'json' }"
                @click="switchTab('json')"
              >
                <a>
                  <span>JSON 数据</span>
                </a>
              </li>
            </ul>
          </div>
          <div v-show="activeTab === 'json'">
            <div class="field">
              <label class="label">JSON：</label>
              <textarea
                ref="resultTextarea"
                v-model="result"
                class="textarea is-warning"
                rows="20"
                placeholder="输出结果"
              ></textarea>
            </div>
          </div>
          <div v-show="activeTab === 'visual'" class="visual">
            <div class="field">
              <label class="label">VISUAL：</label>
            </div>
            <div class="result-list">
              <div
                v-for="(item, index) in rerankResults"
                :key="index"
                class="result-item"
              >
                <div v-if="index > 0"><hr /></div>
                <div class="field has-addons">
                  <p class="control">
                    <a class="button is-static"> {{ index + 1 }}. </a>
                  </p>
                  <div class="control is-expanded">
                    <input
                      class="input is-warning"
                      type="text"
                      :value="item.document.text"
                      readonly
                    />
                  </div>
                </div>
                <div class="field">
                  <progress
                    class="progress is-warning"
                    :value="getScorePercent(item.relevance_score)"
                    min="1"
                    max="100"
                  >
                    {{ getScorePercent(item.relevance_score) }}%
                  </progress>
                </div>
                <div class="field" style="margin-bottom: 12px">
                  <span class="tag is-warning is-light">
                    分数：<span class="score"
                      >{{ item.relevance_score.toFixed(5) }}</span
                    >
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="/static/home/vue3.global.prod.js"></script>
    <script>
      const { createApp, ref, onMounted, reactive } = Vue;

      createApp({
        setup() {
          // 响应式数据
          const address = ref("");
          const key = ref("");
          const modelName = ref("");
          const question = ref("");
          const result = ref("");
          const resultTextarea = ref(null);
          const showAddressTip = ref(false);
          const showModelNameTip = ref(false);
          const showQuestionTip = ref(false);
          const showInputTip = ref(false);
          const loading = ref(false);
          const activeTab = ref("visual"); // 默认显示可视化标签页
          const rerankResults = ref([]); // 存储重排结果

          // 使用 reactive 创建响应式数组
          const inputs = reactive([
            {
              value: "",
              placeholder: "请输入文本",
            },
            {
              value: "",
              placeholder: "请输入文本",
            },
            {
              value: "",
              placeholder: "请输入文本",
            },
          ]);

          // 本地存储键名映射
          const storageKeys = {
            address: "rerank_address",
            key: "rerank_key",
            modelName: "rerank_modelName",
            question: "rerank_question",
            inputs: "rerank_inputs", // 存储所有输入框数据
            result: "rerank_result",
          };

          // 从本地存储加载数据
          const loadFromStorage = () => {
            address.value =
              localStorage.getItem(storageKeys.address) ||
              `${location.origin}/v1/rerank`;
            key.value = localStorage.getItem(storageKeys.key) || "";
            modelName.value =
              localStorage.getItem(storageKeys.modelName) ||
              "bge-reranker-v2-m3";
            question.value =
              localStorage.getItem(storageKeys.question) ||
              "苹果公司的产品有哪些？";

            // 加载输入框数据
            const savedInputs = localStorage.getItem(storageKeys.inputs);
            if (savedInputs) {
              const parsedInputs = JSON.parse(savedInputs);
              // 清空现有输入框
              inputs.length = 0;
              // 添加保存的输入框数据
              parsedInputs.forEach((input) => {
                inputs.push(input);
              });
            } else {
              // 如果没有保存的数据，使用默认值
              inputs.length = 0;
              inputs.push(
                {
                  value:
                    "Apple 是一家伟大的公司，他们的主要产品有 iPhone、iPad 和 Mac。",
                  placeholder: "请输入文本",
                },
                {
                  value:
                    "Microsoft 是一家伟大的公司，他们的主要产品有 Windows、Xbox 和 Surface。",
                  placeholder: "请输入文本",
                },
                {
                  value:
                    "OpenAI 是一家伟大的公司，他们的主要产品有 GPT-3、GPT-4o、GPT-5。",
                  placeholder: "请输入文本",
                }
              );
            }

            result.value = localStorage.getItem(storageKeys.result) || "";

            // 如果有结果数据，解析并显示可视化结果
            if (result.value) {
              try {
                const parsedData = JSON.parse(result.value);
                if (parsedData.results) {
                  rerankResults.value = parsedData.results;
                }
              } catch (e) {
                console.error("解析存储结果失败:", e);
              }
            }
          };

          // 只在请求成功后保存数据到本地存储
          const saveToStorage = () => {
            localStorage.setItem(storageKeys.address, address.value);
            localStorage.setItem(storageKeys.key, key.value);
            localStorage.setItem(storageKeys.modelName, modelName.value);
            localStorage.setItem(storageKeys.question, question.value);
            localStorage.setItem(storageKeys.inputs, JSON.stringify(inputs));
            localStorage.setItem(storageKeys.result, result.value);
          };

          // 添加新的输入框
          const addInput = () => {
            inputs.push({
              value: "",
              placeholder: "请输入文本",
            });
          };

          const scrollTextareaToBottom = (refTextarea) => {
            let scheduled = false; // ← 改名更准确

            const innerScrollTextareaToBottom = () => {
              if (scheduled) {
                return;
              }
              scheduled = true;

              requestAnimationFrame(() => {
                if (refTextarea.value) {
                  refTextarea.value.scrollTop = refTextarea.value.scrollHeight;
                }
                scheduled = false;
              });
            };

            return innerScrollTextareaToBottom;
          };

          const scrollResultToBottom = scrollTextareaToBottom(resultTextarea);

          // 发送请求
          const sendRequest = async () => {
            // 重置提示信息
            showAddressTip.value = false;
            showModelNameTip.value = false;
            showQuestionTip.value = false;
            showInputTip.value = false;

            // 验证输入
            if (!address.value.trim()) {
              showAddressTip.value = true;
              return;
            }

            if (!modelName.value.trim()) {
              showModelNameTip.value = true;
              return;
            }

            if (!question.value.trim()) {
              showQuestionTip.value = true;
              return;
            }

            // 检查是否有至少一个非空输入
            const hasNonEmptyInput = inputs.some((input) => input.value.trim());
            if (!hasNonEmptyInput) {
              showInputTip.value = true;
              return;
            }

            loading.value = true;

            try {
              // 过滤掉空的输入
              const documents = inputs
                .map((input) => input.value.trim())
                .filter((value) => value);

              const response = await fetch(address.value, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${key.value}`,
                },
                body: JSON.stringify({
                  model: modelName.value,
                  top_n: documents.length,
                  query: question.value,
                  documents: documents,
                }),
              });

              const resData = await response.json();

              result.value = JSON.stringify(resData, null, 2);

              if (resData.results === undefined) {
                // 如果结果格式不正确，切换到JSON标签页
                activeTab.value = "json";
              } else {
                // 解析结果并显示可视化
                rerankResults.value = resData.results;
                // 切换到可视化标签页
                activeTab.value = "visual";
                // 保存数据到本地存储
                saveToStorage();
              }
            } catch (error) {
              console.error("Error:", error);
              result.value = `请求出错: ${error.message}`;
              activeTab.value = "json";
            } finally {
              loading.value = false;
            }
          };

          // 切换标签页
          const switchTab = (tab) => {
            activeTab.value = tab;
          };

          // 计算分数百分比
          const getScorePercent = (score) => {
            let percent = (score * 100).toFixed(2);
            if (percent < 1) {
              percent = 1;
            }
            return percent;
          };

          // 组件挂载时加载本地存储
          onMounted(() => {
            loadFromStorage();
          });

          return {
            address,
            key,
            modelName,
            question,
            inputs,
            result,
            showAddressTip,
            showModelNameTip,
            showQuestionTip,
            showInputTip,
            loading,
            activeTab,
            rerankResults,
            addInput,
            sendRequest,
            switchTab,
            getScorePercent,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
